<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TalkArena - å¤šæ¨¡æ€äº¤äº’æ¼”ç¤º</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .panel {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        
        .panel-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #333;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .connection-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-left: auto;
        }
        
        .connection-status.connected {
            background: #d4edda;
            color: #155724;
        }
        
        .connection-status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }
        
        .connection-status.connecting {
            background: #fff3cd;
            color: #856404;
        }
        
        /* çŠ¶æ€æ ‡å¿—åŒºåŸŸ */
        .status-bar {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .status-item {
            flex: 1;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }
        
        .status-item.active {
            border-color: #667eea;
            background: #f0f3ff;
        }
        
        .status-icon {
            font-size: 48px;
            margin-bottom: 8px;
            display: block;
        }
        
        .status-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 4px;
        }
        
        .status-value {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }
        
        .status-score {
            font-size: 12px;
            color: #667eea;
            margin-top: 4px;
        }
        
        /* æ§åˆ¶æŒ‰é’® */
        .controls {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: #5a6fd6;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-primary:disabled {
            background: #a0aec0;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: #f8f9fa;
            color: #333;
            border: 2px solid #e9ecef;
        }
        
        .btn-secondary:hover {
            background: #e9ecef;
        }
        
        .btn-danger {
            background: #ff6b6b;
            color: white;
        }
        
        .btn-danger:hover {
            background: #ff5252;
        }
        
        /* æ¨¡æ‹Ÿå™¨åŒºåŸŸ */
        .simulator {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .simulator-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #555;
        }
        
        .emotion-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .emotion-btn {
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-size: 24px;
            transition: all 0.2s;
        }
        
        .emotion-btn:hover {
            border-color: #667eea;
            transform: scale(1.1);
        }
        
        .emotion-btn.selected {
            border-color: #667eea;
            background: #f0f3ff;
        }
        
        .voice-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
        }
        
        /* ç»“æœå±•ç¤º */
        .result-panel {
            background: #f0f3ff;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }
        
        .result-panel.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .result-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
        }
        
        .result-content {
            font-size: 14px;
            line-height: 1.6;
            color: #555;
            white-space: pre-wrap;
        }
        
        /* TTS æµ‹è¯•åŒºåŸŸ */
        .tts-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e9ecef;
        }
        
        .tts-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 12px;
            resize: vertical;
        }
        
        .tts-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        /* æ³¢å½¢åŠ¨ç”» */
        .waveform {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 4px;
            height: 40px;
            margin-top: 12px;
        }
        
        .waveform span {
            width: 4px;
            background: #667eea;
            border-radius: 2px;
            animation: wave 1s ease-in-out infinite;
        }
        
        .waveform span:nth-child(1) { animation-delay: 0s; height: 20%; }
        .waveform span:nth-child(2) { animation-delay: 0.1s; height: 40%; }
        .waveform span:nth-child(3) { animation-delay: 0.2s; height: 60%; }
        .waveform span:nth-child(4) { animation-delay: 0.3s; height: 40%; }
        .waveform span:nth-child(5) { animation-delay: 0.4s; height: 20%; }
        
        @keyframes wave {
            0%, 100% { transform: scaleY(0.5); }
            50% { transform: scaleY(1); }
        }
        
        /* API é…ç½®åŒºåŸŸ */
        .api-config {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
        }
        
        .api-config input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .api-config label {
            display: block;
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }
        
        /* é”™è¯¯æç¤º */
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
            font-size: 14px;
            display: none;
        }
        
        .error-message.show {
            display: block;
        }
        
        /* å“åº”å¼ */
        @media (max-width: 600px) {
            .status-bar {
                flex-direction: column;
            }
            
            .emotion-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .voice-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ­ TalkArena å¤šæ¨¡æ€æ¼”ç¤º</h1>
        
        <!-- API è¿æ¥é…ç½® -->
        <div class="panel">
            <div class="panel-title">
                ğŸ”Œ API è¿æ¥é…ç½®
                <span id="connection-status" class="connection-status disconnected">
                    <span>â—</span> æœªè¿æ¥
                </span>
            </div>
            
            <div class="api-config">
                <label>åç«¯ API åœ°å€</label>
                <input type="text" id="api-url" value="http://localhost:5000" placeholder="http://localhost:5000">
            </div>
            
            <div class="controls">
                <button class="btn btn-primary" onclick="testConnection()">
                    ğŸ”— æµ‹è¯•è¿æ¥
                </button>
                <button class="btn btn-secondary" onclick="useMockMode()">
                    ğŸ”§ æ¨¡æ‹Ÿæ¨¡å¼
                </button>
            </div>
            
            <div id="connection-error" class="error-message"></div>
        </div>
        
        <!-- çŠ¶æ€æ ‡å¿—åŒºåŸŸ -->
        <div class="panel">
            <div class="panel-title">
                ğŸ“Š å®æ—¶çŠ¶æ€ç›‘æµ‹
            </div>
            
            <div class="status-bar">
                <div class="status-item" id="emotion-status">
                    <span class="status-icon" id="emotion-icon">â“</span>
                    <div class="status-label">è¡¨æƒ…çŠ¶æ€</div>
                    <div class="status-value" id="emotion-text">æœªæ£€æµ‹</div>
                    <div class="status-score" id="emotion-score"></div>
                </div>
                
                <div class="status-item" id="voice-status">
                    <span class="status-icon" id="voice-icon">â“</span>
                    <div class="status-label">è¯­éŸ³çŠ¶æ€</div>
                    <div class="status-value" id="voice-text">æœªæ£€æµ‹</div>
                    <div class="status-score" id="voice-score"></div>
                </div>
            </div>
            
            <div class="waveform" id="voice-waveform" style="display: none;">
                <span></span><span></span><span></span><span></span><span></span>
            </div>
        </div>
        
        <!-- æ¨¡æ‹Ÿå™¨æ§åˆ¶ -->
        <div class="panel">
            <div class="panel-title">
                ğŸ® çŠ¶æ€æ¨¡æ‹Ÿå™¨ï¼ˆæµ‹è¯•ç”¨ï¼‰
            </div>
            
            <div class="simulator">
                <div class="simulator-title">é€‰æ‹©è¡¨æƒ…çŠ¶æ€</div>
                <div class="emotion-grid">
                    <button class="emotion-btn" data-emotion="happy" title="å¼€å¿ƒ">ğŸ˜Š</button>
                    <button class="emotion-btn" data-emotion="sad" title="éš¾è¿‡">ğŸ˜¢</button>
                    <button class="emotion-btn" data-emotion="angry" title="ç”Ÿæ°”">ğŸ˜ </button>
                    <button class="emotion-btn" data-emotion="surprised" title="æƒŠè®¶">ğŸ˜²</button>
                    <button class="emotion-btn" data-emotion="nervous" title="ç´§å¼ ">ğŸ˜°</button>
                    <button class="emotion-btn" data-emotion="tired" title="ç–²æƒ«">ğŸ˜´</button>
                    <button class="emotion-btn" data-emotion="neutral" title="å¹³é™">ğŸ˜</button>
                    <button class="emotion-btn" data-emotion="confident" title="è‡ªä¿¡">ğŸ˜</button>
                </div>
                
                <div class="simulator-title">é€‰æ‹©è¯­éŸ³çŠ¶æ€</div>
                <div class="voice-grid">
                    <button class="emotion-btn" data-voice="calm" title="æ²‰ç¨³">ğŸµ</button>
                    <button class="emotion-btn" data-voice="excited" title="æ¿€åŠ¨">ğŸ¸</button>
                    <button class="emotion-btn" data-voice="hesitant" title="çŠ¹è±«">ğŸ“¢</button>
                    <button class="emotion-btn" data-voice="agitated" title="ç„¦èº">ğŸ¥</button>
                    <button class="emotion-btn" data-voice="neutral" title="å¹³å’Œ">ğŸ¤</button>
                </div>
            </div>
            
            <div class="controls" style="margin-top: 20px;">
                <button class="btn btn-primary" id="detect-btn" onclick="analyzeWithAPI()">
                    ğŸ” è°ƒç”¨åç«¯åˆ†æ
                </button>
                <button class="btn btn-secondary" onclick="clearStatus()">
                    ğŸ”„ æ¸…é™¤çŠ¶æ€
                </button>
                <button class="btn btn-danger" onclick="randomizeStatus()">
                    ğŸ² éšæœºçŠ¶æ€
                </button>
            </div>
            
            <div id="analysis-error" class="error-message"></div>
        </div>
        
        <!-- æµ‹è¯•æ¶ˆæ¯åŒºåŸŸ -->
        <div class="panel">
            <div class="panel-title">
                ğŸ’¬ å‘é€æµ‹è¯•æ¶ˆæ¯
            </div>
            
            <textarea class="tts-input" id="test-message" rows="3" placeholder="è¾“å…¥æµ‹è¯•æ¶ˆæ¯..."></textarea>
            
            <div class="controls">
                <button class="btn btn-primary" id="send-btn" onclick="sendTestMessage()">
                    ğŸ“¤ å‘é€æ¶ˆæ¯
                </button>
                <button class="btn btn-secondary" onclick="generateRandomMessage()">
                    ğŸ“ éšæœºæ¶ˆæ¯
                </button>
            </div>
            
            <div class="result-panel" id="result-panel">
                <div class="result-title">ğŸ“Š åˆ†æç»“æœ</div>
                <div class="result-content" id="result-content"></div>
            </div>
            
            <div id="send-error" class="error-message"></div>
        </div>
        
        <!-- TTS æµ‹è¯•åŒºåŸŸ -->
        <div class="panel">
            <div class="panel-title">
                ğŸ”Š TTS è¯­éŸ³æµ‹è¯•
            </div>
            
            <textarea class="tts-input" id="tts-text" rows="3" placeholder="è¾“å…¥è¦è½¬æ¢ä¸ºè¯­éŸ³çš„æ–‡æœ¬..."></textarea>
            
            <div class="controls">
                <button class="btn btn-primary" onclick="testTTS()">
                    ğŸ”Š ç”Ÿæˆè¯­éŸ³
                </button>
                <button class="btn btn-secondary" onclick="testPresetMessages()">
                    ğŸ“‹ é¢„è®¾æ¶ˆæ¯
                </button>
            </div>
            
            <div id="tts-status" style="margin-top: 12px; color: #666; font-size: 14px;"></div>
        </div>
    </div>

    <script>
        // ============================================
        // é…ç½®
        // ============================================
        const CONFIG = {
            // API åŸºç¡€åœ°å€ï¼Œå¯ä»¥é€šè¿‡è¾“å…¥æ¡†ä¿®æ”¹
            get apiBaseUrl() {
                return document.getElementById('api-url').value.trim() || 'http://localhost:5000';
            },
            // æ˜¯å¦ä½¿ç”¨æ¨¡æ‹Ÿæ¨¡å¼ï¼ˆä¸è¿æ¥åç«¯ï¼‰
            useMockMode: false
        };
        
        // ============================================
        // çŠ¶æ€æ˜ å°„
        // ============================================
        const emotionMap = {
            'happy': { icon: 'ğŸ˜Š', text: 'å¼€å¿ƒ', color: '#ffd93d' },
            'sad': { icon: 'ğŸ˜¢', text: 'éš¾è¿‡', color: '#6bcf7f' },
            'angry': { icon: 'ğŸ˜ ', text: 'ç”Ÿæ°”', color: '#ff6b6b' },
            'surprised': { icon: 'ğŸ˜²', text: 'æƒŠè®¶', color: '#ffa502' },
            'nervous': { icon: 'ğŸ˜°', text: 'ç´§å¼ ', color: '#ff9f43' },
            'tired': { icon: 'ğŸ˜´', text: 'ç–²æƒ«', color: '#a29bfe' },
            'neutral': { icon: 'ğŸ˜', text: 'å¹³é™', color: '#dfe6e9' },
            'confident': { icon: 'ğŸ˜', text: 'è‡ªä¿¡', color: '#74b9ff' }
        };
        
        const voiceMap = {
            'calm': { icon: 'ğŸµ', text: 'æ²‰ç¨³', color: '#00b894' },
            'excited': { icon: 'ğŸ¸', text: 'æ¿€åŠ¨', color: '#e17055' },
            'hesitant': { icon: 'ğŸ“¢', text: 'çŠ¹è±«', color: '#fdcb6e' },
            'agitated': { icon: 'ğŸ¥', text: 'ç„¦èº', color: '#d63031' },
            'neutral': { icon: 'ğŸ¤', text: 'å¹³å’Œ', color: '#b2bec3' }
        };
        
        // å½“å‰é€‰ä¸­çš„çŠ¶æ€
        let selectedEmotion = null;
        let selectedVoice = null;
        
        // ============================================
        // API è°ƒç”¨å‡½æ•°
        // ============================================
        
        // æµ‹è¯•åç«¯è¿æ¥
        async function testConnection() {
            updateConnectionStatus('connecting');
            hideError('connection-error');
            
            try {
                const response = await fetch(`${CONFIG.apiBaseUrl}/api/multimodal/test`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        updateConnectionStatus('connected');
                        CONFIG.useMockMode = false;
                        showNotification('âœ… åç«¯è¿æ¥æˆåŠŸï¼');
                    } else {
                        throw new Error(data.error || 'è¿æ¥å¤±è´¥');
                    }
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                updateConnectionStatus('disconnected');
                showError('connection-error', `è¿æ¥å¤±è´¥: ${error.message}. è¯·ç¡®ä¿åç«¯æœåŠ¡å·²å¯åŠ¨ (python multimodal_server.py)`);
            }
        }
        
        // åˆ‡æ¢åˆ°æ¨¡æ‹Ÿæ¨¡å¼
        function useMockMode() {
            CONFIG.useMockMode = true;
            updateConnectionStatus('disconnected');
            showNotification('ğŸ”§ å·²åˆ‡æ¢åˆ°æ¨¡æ‹Ÿæ¨¡å¼ï¼ˆä¸è¿æ¥åç«¯ï¼‰');
        }
        
        // è°ƒç”¨åç«¯ API è¿›è¡Œåˆ†æ
        async function analyzeWithAPI() {
            if (!selectedEmotion && !selectedVoice) {
                alert('è¯·å…ˆé€‰æ‹©è¡¨æƒ…å’Œè¯­éŸ³çŠ¶æ€ï¼');
                return;
            }
            
            setLoading('detect-btn', true);
            hideError('analysis-error');
            
            // æ„å»ºè¯·æ±‚æ•°æ®
            const emotionFeatures = selectedEmotion ? {
                eyeOpenness: 0.85,
                smileScore: emotionMap[selectedEmotion].text === 'å¼€å¿ƒ' ? 0.72 : 0.2,
                confidence: emotionMap[selectedEmotion].text === 'è‡ªä¿¡' ? 78 : 45,
                nervousness: emotionMap[selectedEmotion].text === 'ç´§å¼ ' ? 75 : 30,
                dominantEmotion: selectedEmotion
            } : null;
            
            const voiceFeatures = selectedVoice ? {
                speechRate: voiceMap[selectedVoice].text === 'æ¿€åŠ¨' ? 4.8 : 3.2,
                voiceConfidence: voiceMap[selectedVoice].text === 'æ²‰ç¨³' ? 80 : 50,
                voiceNervousness: voiceMap[selectedVoice].text === 'çŠ¹è±«' ? 70 : 25,
                emotionLabel: selectedVoice
            } : null;
            
            if (CONFIG.useMockMode) {
                // æ¨¡æ‹Ÿæ¨¡å¼
                simulateDetection();
                setLoading('detect-btn', false);
                return;
            }
            
            try {
                const response = await fetch(`${CONFIG.apiBaseUrl}/api/multimodal/analyze`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: 'æµ‹è¯•æ¶ˆæ¯',
                        emotion_features: emotionFeatures,
                        voice_features: voiceFeatures
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        displayAPIResult(data.data);
                    } else {
                        throw new Error(data.error);
                    }
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                showError('analysis-error', `åˆ†æå¤±è´¥: ${error.message}`);
                // å¤±è´¥åè‡ªåŠ¨åˆ‡æ¢åˆ°æ¨¡æ‹Ÿæ¨¡å¼
                simulateDetection();
            } finally {
                setLoading('detect-btn', false);
            }
        }
        
        // å‘é€æµ‹è¯•æ¶ˆæ¯åˆ°åç«¯
        async function sendTestMessage() {
            const message = document.getElementById('test-message').value.trim();
            if (!message) {
                alert('è¯·è¾“å…¥æµ‹è¯•æ¶ˆæ¯ï¼');
                return;
            }
            
            setLoading('send-btn', true);
            hideError('send-error');
            
            if (CONFIG.useMockMode || !selectedEmotion) {
                // æ¨¡æ‹Ÿæ¨¡å¼
                const result = generateMockResult(message);
                showResult(result);
                setLoading('send-btn', false);
                return;
            }
            
            try {
                const emotionFeatures = selectedEmotion ? {
                    eyeOpenness: 0.85,
                    smileScore: emotionMap[selectedEmotion].text === 'å¼€å¿ƒ' ? 0.72 : 0.2,
                    confidence: emotionMap[selectedEmotion].text === 'è‡ªä¿¡' ? 78 : 45,
                    nervousness: emotionMap[selectedEmotion].text === 'ç´§å¼ ' ? 75 : 30,
                    dominantEmotion: selectedEmotion
                } : null;
                
                const voiceFeatures = selectedVoice ? {
                    speechRate: voiceMap[selectedVoice].text === 'æ¿€åŠ¨' ? 4.8 : 3.2,
                    voiceConfidence: voiceMap[selectedVoice].text === 'æ²‰ç¨³' ? 80 : 50,
                    voiceNervousness: voiceMap[selectedVoice].text === 'çŠ¹è±«' ? 70 : 25,
                    emotionLabel: selectedVoice
                } : null;
                
                const response = await fetch(`${CONFIG.apiBaseUrl}/api/multimodal/analyze`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: message,
                        emotion_features: emotionFeatures,
                        voice_features: voiceFeatures
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        displayAPIResult(data.data);
                    } else {
                        throw new Error(data.error);
                    }
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                showError('send-error', `å‘é€å¤±è´¥: ${error.message}`);
                // ä½¿ç”¨æ¨¡æ‹Ÿç»“æœ
                const result = generateMockResult(message);
                showResult(result);
            } finally {
                setLoading('send-btn', false);
            }
        }
        
        // æ˜¾ç¤º API è¿”å›çš„ç»“æœ
        function displayAPIResult(data) {
            const result = {
                overallScore: Math.round(data.overall_score),
                emotion: data.status_icons?.emotion_status?.split('Â·')[0] || 'neutral',
                voice: data.status_icons?.voice_status?.split('Â·')[0] || 'neutral',
                textScore: Math.round(data.breakdown?.text || 50),
                emotionScore: Math.round(data.breakdown?.emotion || 50),
                voiceScore: Math.round(data.breakdown?.voice || 50),
                feedback: data.feedback,
                inconsistencies: data.inconsistencies || [],
                suggestions: data.suggestions || []
            };
            
            showResult(result);
            
            // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
            if (data.emotion_analysis) {
                updateEmotionStatus(
                    data.emotion_analysis.dominant_emotion,
                    Math.round(data.emotion_analysis.score)
                );
            }
            
            if (data.voice_analysis) {
                updateVoiceStatus(
                    data.voice_analysis.emotion_label,
                    Math.round(data.voice_analysis.score)
                );
            }
        }
        
        // ============================================
        // UI è¾…åŠ©å‡½æ•°
        // ============================================
        
        function updateConnectionStatus(status) {
            const statusEl = document.getElementById('connection-status');
            statusEl.className = 'connection-status ' + status;
            
            if (status === 'connected') {
                statusEl.innerHTML = '<span>â—</span> å·²è¿æ¥';
            } else if (status === 'connecting') {
                statusEl.innerHTML = '<span>â—</span> è¿æ¥ä¸­...';
            } else {
                statusEl.innerHTML = '<span>â—</span> æœªè¿æ¥';
            }
        }
        
        function setLoading(btnId, loading) {
            const btn = document.getElementById(btnId);
            if (loading) {
                btn.disabled = true;
                btn.dataset.originalText = btn.textContent;
                btn.textContent = 'â³ å¤„ç†ä¸­...';
            } else {
                btn.disabled = false;
                btn.textContent = btn.dataset.originalText || btn.textContent.replace('â³ å¤„ç†ä¸­...', '');
            }
        }
        
        function showError(elementId, message) {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.classList.add('show');
        }
        
        function hideError(elementId) {
            const el = document.getElementById(elementId);
            el.classList.remove('show');
        }
        
        function showNotification(message) {
            // ç®€å•çš„é€šçŸ¥å®ç°
            const div = document.createElement('div');
            div.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #667eea;
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 1000;
                animation: slideIn 0.3s ease;
            `;
            div.textContent = message;
            document.body.appendChild(div);
            
            setTimeout(() => {
                div.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => div.remove(), 300);
            }, 3000);
        }
        
        // ============================================
        // åŸæœ‰åŠŸèƒ½ï¼ˆæ¨¡æ‹Ÿæ¨¡å¼ï¼‰
        // ============================================
        
        // ç»‘å®šè¡¨æƒ…æŒ‰é’®äº‹ä»¶
        document.querySelectorAll('.emotion-btn[data-emotion]').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.emotion-btn[data-emotion]').forEach(b => b.classList.remove('selected'));
                this.classList.add('selected');
                selectedEmotion = this.dataset.emotion;
            });
        });
        
        // ç»‘å®šè¯­éŸ³æŒ‰é’®äº‹ä»¶
        document.querySelectorAll('.emotion-btn[data-voice]').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.emotion-btn[data-voice]').forEach(b => b.classList.remove('selected'));
                this.classList.add('selected');
                selectedVoice = this.dataset.voice;
            });
        });
        
        function updateEmotionStatus(emotion, score = null) {
            const data = emotionMap[emotion] || emotionMap['neutral'];
            document.getElementById('emotion-icon').textContent = data.icon;
            document.getElementById('emotion-text').textContent = data.text;
            document.getElementById('emotion-status').style.borderColor = data.color;
            document.getElementById('emotion-status').classList.add('active');
            
            if (score !== null) {
                document.getElementById('emotion-score').textContent = `å¾—åˆ†: ${score}/100`;
            }
        }
        
        function updateVoiceStatus(voice, score = null) {
            const data = voiceMap[voice] || voiceMap['neutral'];
            document.getElementById('voice-icon').textContent = data.icon;
            document.getElementById('voice-text').textContent = data.text;
            document.getElementById('voice-status').style.borderColor = data.color;
            document.getElementById('voice-status').classList.add('active');
            
            if (score !== null) {
                document.getElementById('voice-score').textContent = `å¾—åˆ†: ${score}/100`;
            }
            
            document.getElementById('voice-waveform').style.display = 'flex';
        }
        
        function clearStatus() {
            document.getElementById('emotion-icon').textContent = 'â“';
            document.getElementById('emotion-text').textContent = 'æœªæ£€æµ‹';
            document.getElementById('emotion-score').textContent = '';
            document.getElementById('emotion-status').style.borderColor = '#e9ecef';
            document.getElementById('emotion-status').classList.remove('active');
            
            document.getElementById('voice-icon').textContent = 'â“';
            document.getElementById('voice-text').textContent = 'æœªæ£€æµ‹';
            document.getElementById('voice-score').textContent = '';
            document.getElementById('voice-status').style.borderColor = '#e9ecef';
            document.getElementById('voice-status').classList.remove('active');
            document.getElementById('voice-waveform').style.display = 'none';
            
            document.querySelectorAll('.emotion-btn').forEach(b => b.classList.remove('selected'));
            selectedEmotion = null;
            selectedVoice = null;
        }
        
        function simulateDetection() {
            if (selectedEmotion) {
                const score = Math.floor(Math.random() * 30) + 60;
                updateEmotionStatus(selectedEmotion, score);
            }
            
            if (selectedVoice) {
                const score = Math.floor(Math.random() * 30) + 60;
                updateVoiceStatus(selectedVoice, score);
            }
            
            if (!selectedEmotion && !selectedVoice) {
                alert('è¯·å…ˆé€‰æ‹©è¡¨æƒ…å’Œè¯­éŸ³çŠ¶æ€ï¼');
            }
        }
        
        function randomizeStatus() {
            const emotions = Object.keys(emotionMap);
            const voices = Object.keys(voiceMap);
            
            const randomEmotion = emotions[Math.floor(Math.random() * emotions.length)];
            const randomVoice = voices[Math.floor(Math.random() * voices.length)];
            
            const emotionScore = Math.floor(Math.random() * 40) + 50;
            const voiceScore = Math.floor(Math.random() * 40) + 50;
            
            updateEmotionStatus(randomEmotion, emotionScore);
            updateVoiceStatus(randomVoice, voiceScore);
            
            document.querySelectorAll('.emotion-btn').forEach(b => b.classList.remove('selected'));
            document.querySelector(`[data-emotion="${randomEmotion}"]`).classList.add('selected');
            document.querySelector(`[data-voice="${randomVoice}"]`).classList.add('selected');
            
            selectedEmotion = randomEmotion;
            selectedVoice = randomVoice;
        }
        
        function generateRandomMessage() {
            const messages = [
                "å¤§èˆ…ï¼Œæˆ‘æ•¬æ‚¨ä¸€æ¯ï¼",
                "æ‚¨è¯´å¾—å¯¹ï¼Œæˆ‘è®°ä½äº†",
                "è¿™æ¯é…’æˆ‘å¿…é¡»å¹²äº†ï¼",
                "è¿˜å¾—æ˜¯æ‚¨æœ‰ç»éªŒå•Š",
                "æ™šè¾ˆå…ˆå¹²ä¸ºæ•¬",
                "æ‚¨å¤ªå®¢æ°”äº†",
                "æˆ‘å“ªæ•¢è·Ÿæ‚¨æ¯”å•Š"
            ];
            const randomMsg = messages[Math.floor(Math.random() * messages.length)];
            document.getElementById('test-message').value = randomMsg;
        }
        
        function generateMockResult(message) {
            const score = Math.floor(Math.random() * 30) + 60;
            const emotions = Object.keys(emotionMap);
            const voices = Object.keys(voiceMap);
            const emotion = emotions[Math.floor(Math.random() * emotions.length)];
            const voice = voices[Math.floor(Math.random() * voices.length)];
            
            const feedbacks = [
                "è¡¨ç°ä¸é”™ï¼Œæ°”åœºå¾ˆè¶³ï¼",
                "è¡¨æƒ…è‡ªç„¶ï¼Œè¯­é€Ÿé€‚ä¸­",
                "å¯ä»¥æ›´è‡ªä¿¡ä¸€äº›",
                "æ³¨æ„çœ¼ç¥äº¤æµ",
                "è¯­æ°”åšå®šæœ‰åŠ›"
            ];
            
            return {
                overallScore: score,
                emotion: emotion,
                voice: voice,
                textScore: Math.floor(Math.random() * 20) + 70,
                emotionScore: Math.floor(Math.random() * 20) + 70,
                voiceScore: Math.floor(Math.random() * 20) + 70,
                feedback: feedbacks[Math.floor(Math.random() * feedbacks.length)],
                inconsistencies: Math.random() > 0.7 ? ["è¯è¯­å¼ºç¡¬ä½†è¡¨æƒ…ç´§å¼ "] : [],
                suggestions: Math.random() > 0.5 ? ["å»ºè®®å¤šè¿›è¡Œçœ¼ç¥äº¤æµ"] : []
            };
        }
        
        function showResult(result) {
            const emotionData = emotionMap[result.emotion] || emotionMap['neutral'];
            const voiceData = voiceMap[result.voice] || voiceMap['neutral'];
            
            const resultContent = `
ğŸ“Š ç»¼åˆè¯„åˆ†: ${result.overallScore}/100

ğŸ“ˆ åˆ†é¡¹å¾—åˆ†:
   æ–‡æœ¬: ${result.textScore} | è¡¨æƒ…: ${result.emotionScore} | è¯­éŸ³: ${result.voiceScore}

ğŸ­ è¡¨æƒ…çŠ¶æ€: ${emotionData.icon} ${emotionData.text}
ğŸ¤ è¯­éŸ³çŠ¶æ€: ${voiceData.icon} ${voiceData.text}

ğŸ’¡ è¯„ä»·: ${result.feedback}
${result.inconsistencies.length > 0 ? `âš ï¸ æ³¨æ„: ${result.inconsistencies.join(', ')}` : ''}
${result.suggestions.length > 0 ? `ğŸ“ å»ºè®®: ${result.suggestions.join(', ')}` : ''}
            `.trim();
            
            document.getElementById('result-content').textContent = resultContent;
            document.getElementById('result-panel').classList.add('show');
            
            updateEmotionStatus(result.emotion, result.emotionScore);
            updateVoiceStatus(result.voice, result.voiceScore);
        }
        
        function testTTS() {
            const text = document.getElementById('tts-text').value.trim();
            if (!text) {
                alert('è¯·è¾“å…¥è¦è½¬æ¢ä¸ºè¯­éŸ³çš„æ–‡æœ¬ï¼');
                return;
            }
            
            const statusDiv = document.getElementById('tts-status');
            statusDiv.textContent = 'ğŸ”Š æ­£åœ¨ç”Ÿæˆè¯­éŸ³...';
            
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'zh-CN';
                utterance.rate = 0.9;
                utterance.pitch = 1.0;
                
                utterance.onstart = function() {
                    statusDiv.textContent = 'ğŸ”Š æ­£åœ¨æ’­æ”¾...';
                    document.getElementById('voice-waveform').style.display = 'flex';
                };
                
                utterance.onend = function() {
                    statusDiv.textContent = 'âœ… æ’­æ”¾å®Œæˆ';
                    document.getElementById('voice-waveform').style.display = 'none';
                };
                
                utterance.onerror = function(e) {
                    statusDiv.textContent = 'âŒ æ’­æ”¾å¤±è´¥: ' + e.error;
                    document.getElementById('voice-waveform').style.display = 'none';
                };
                
                window.speechSynthesis.speak(utterance);
            } else {
                statusDiv.textContent = 'âŒ æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³åˆæˆ';
            }
        }
        
        function testPresetMessages() {
            const presets = [
                "å“ˆå“ˆï¼Œå°å­ä¼šè¯´è¯ï¼æ¥ï¼Œå¹²äº†è¿™æ¯ï¼",
                "ä¸é”™ä¸é”™ï¼Œæœ‰è¿›æ­¥ï¼",
                "è¿™æ¯é…’ä½ å¿…é¡»å–ï¼Œä¸å–å°±æ˜¯ä¸ç»™æˆ‘é¢å­",
                "å¹´è½»äººè¦æ‡‚å¾—è§„çŸ©",
                "æˆ‘çœ‹å¥½ä½ ï¼Œæ¥ï¼Œå†èµ°ä¸€ä¸ª"
            ];
            
            const randomText = presets[Math.floor(Math.random() * presets.length)];
            document.getElementById('tts-text').value = randomText;
            testTTS();
        }
        
        // ============================================
        // åˆå§‹åŒ–
        // ============================================
        
        window.addEventListener('load', function() {
            console.log('ğŸ­ TalkArena å¤šæ¨¡æ€æ¼”ç¤ºå·²åŠ è½½');
            console.log('ğŸ’¡ æç¤ºï¼šç‚¹å‡»"æµ‹è¯•è¿æ¥"æŒ‰é’®æ£€æŸ¥åç«¯æœåŠ¡');
            
            // è‡ªåŠ¨å°è¯•è¿æ¥åç«¯
            setTimeout(() => {
                testConnection();
            }, 500);
        });
    </script>
</body>
</html>
